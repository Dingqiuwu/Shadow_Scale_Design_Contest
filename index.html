<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‡æ™ºç‰Œè®¾è®¡å¤§èµ›å¡ç‰Œæ•°æ®åº“ alpha</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        body { background-color: #f8f9fa; padding-bottom: 80px; }
        
        /* å¡ç‰Œå›¾ç‰‡å®¹å™¨ï¼Œç”¨äºç»å¯¹å®šä½è§’æ ‡ */
        .card-img-wrapper {
            position: relative;
            background-color: #e9ecef;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        .card-img-top {
            width: 100%;
            height: 300px;
            object-fit: contain;
        }

        .card { 
            height: 100%; 
            transition: transform 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: none;
            overflow: hidden; /* é˜²æ­¢è§’æ ‡æº¢å‡º */
        }
        .card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .oracle-text {
            white-space: pre-wrap;
            font-size: 0.85rem;
            color: #444;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
            border: 1px solid #eee;
        }
        
        /* ğŸ†• åˆ†æ•°è§’æ ‡ (å·¦ä¸Šè§’ï¼ŒåŠ å¤§å­—å·) */
        .score-badge {
            position: absolute;
            bottom: 10px;
            left: 10px;
            font-size: 1.2rem; /* åŠ å¤§å­—å· */
            font-weight: bold;
            color: #fff;
            background-color: rgba(0, 0, 0, 0.7); /* åŠé€æ˜é»‘åº• */
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid #ffd700; /* é‡‘è‰²è¾¹æ¡† */
            box-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 10;
        }

        /* ğŸ†• æ”»é˜²è§’æ ‡ (æµå¼å¸ƒå±€ï¼Œä½äºæ–‡å­—ä¸‹æ–¹) */
        .pt-badge {
            display: inline-block;
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            background-color: #fff;
            padding: 4px 12px;
            /* ç¨å¾®åŠ ç‚¹ä¸Šè¾¹è·ï¼Œä¸æ–‡å­—éš”å¼€ */
            margin-top: 5px; 
        }

        .meta-tag { font-size: 0.8em; color: #6c757d; }
        #loading { display: none; text-align: center; margin: 40px; }
        
        .search-panel {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }
        
        .pagination-container {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        
        #searchCombined {
            border-color: #86b7fe;
            background-color: #f0f7ff;
        }
        #searchCombined:focus {
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        }
    </style>
</head>
<body>

<div class="container mt-4">
    <h1 class="text-center mb-4">ä¸‡æ™ºç‰Œè®¾è®¡å¤§èµ›å¡ç‰Œæ•°æ®åº“alpha</h1>
    
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="search-panel">
                <div class="row g-3">
                    <!-- è”åˆæœç´¢ -->
                    <div class="col-12">
                        <label for="searchCombined" class="form-label fw-bold text-primary">
                            è”åˆæœç´¢
                        </label>
                        <input type="text" class="form-control search-field form-control-lg" id="searchCombined" 
                               placeholder="åŒæ—¶æŸ¥æ‰¾ ç‰Œå / ç±»åˆ« / è§„åˆ™æ–‡æœ¬ / é£å‘³æ–‡å­—">
                    </div>

                    <div class="col-12"><hr class="text-muted"></div>

                    <!-- ç²¾ç¡®ç­›é€‰ -->
                    <div class="col-md-4">
                        <label for="searchName" class="form-label small text-muted">ä»…æœç‰Œå (Name)</label>
                        <input type="text" class="form-control search-field" id="searchName" placeholder="ä¾‹å¦‚ï¼šè†è½²">
                    </div>
                    <div class="col-md-4">
                        <label for="searchAuthor" class="form-label small text-muted">ä»…æœä½œè€… (Author)</label>
                        <input type="text" class="form-control search-field" id="searchAuthor" placeholder="ä¾‹å¦‚ï¼šHalfLife">
                    </div>
                    <div class="col-md-4">
                        <label for="searchWeek" class="form-label small text-muted">ä»…æœæ—¶é—´ (Week)</label>
                        <input type="text" class="form-control search-field" id="searchWeek" placeholder="ä¾‹å¦‚ï¼šç¬¬ä¸‰åå…­å‘¨">
                    </div>

                    <div class="col-md-4">
                        <label for="searchType" class="form-label small text-muted">ä»…æœç±»åˆ« (Type)</label>
                        <input type="text" class="form-control search-field" id="searchType" placeholder="ä¾‹å¦‚ï¼šä¼ å¥‡ç”Ÿç‰©">
                    </div>
                    <div class="col-md-8">
                        <label for="searchOracle" class="form-label small text-muted">ä»…æœè§„åˆ™ (Oracle Text)</label>
                        <input type="text" class="form-control search-field" id="searchOracle" placeholder="ä¾‹å¦‚ï¼šé€ æˆ3ç‚¹ä¼¤å®³">
                    </div>

                    <div class="col-12 text-end mt-3">
                        <button class="btn btn-outline-secondary me-2" onclick="clearSearch()">é‡ç½®æ¡ä»¶</button>
                        <button class="btn btn-primary px-5" onclick="searchData()">æŸ¥è¯¢</button>
                    </div>
                </div>
            </div>

            <div id="resultCount" class="text-center text-muted mt-2" style="font-size: 0.9rem; min-height: 24px;"></div>
        </div>
    </div>

    <div id="loading">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">æ­£åœ¨è¯»å–æ•°æ®åº“...</p>
    </div>

    <div id="results" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4"></div>

    <div id="pagination" class="pagination-container" style="display: none;">
        <button id="btnPrev" class="btn btn-outline-primary" onclick="changePage(-1)">Â« ä¸Šä¸€é¡µ</button>
        <span id="pageInfo" class="fw-bold text-secondary">ç¬¬ 1 / 1 é¡µ</span>
        <button id="btnNext" class="btn btn-outline-primary" onclick="changePage(1)">ä¸‹ä¸€é¡µ Â»</button>
    </div>
</div>

<script>
    let db = null;
    let allCardsData = [];
    let currentPage = 1;
    const pageSize = 20;

    const loadingDiv = document.getElementById('loading');
    const resultsDiv = document.getElementById('results');
    const countDiv = document.getElementById('resultCount');
    const paginationDiv = document.getElementById('pagination');
    const pageInfoSpan = document.getElementById('pageInfo');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');

    async function initApp() {
        loadingDiv.style.display = 'block';
        try {
            if (typeof initSqlJs === 'undefined') throw new Error("sql.js åº“æœªèƒ½åŠ è½½");

            const SQL = await initSqlJs({
                locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
            });

            const dataPromise = fetch("cards.db?" + new Date().getTime()).then(res => {
                if (!res.ok) throw new Error(`æ— æ³•ä¸‹è½½æ•°æ®åº“ (Status: ${res.status})`);
                return res.arrayBuffer();
            });

            const [buf] = await Promise.all([dataPromise]);
            db = new SQL.Database(new Uint8Array(buf));
            
            loadingDiv.style.display = 'none';
            console.log("æ•°æ®åº“åŠ è½½æˆåŠŸ");
            
            searchData(); 
            
        } catch (err) {
            console.error(err);
            loadingDiv.innerHTML = `<div class="alert alert-danger">åŠ è½½å¤±è´¥: ${err.message}<br><small>è¯·ç¡®ä¿ä½¿ç”¨ python -m http.server å¯åŠ¨</small></div>`;
        }
    }

    function runQuery(sql, isRandom = false) {
        if (!db) return;
        
        allCardsData = [];
        currentPage = 1;
        resultsDiv.innerHTML = '';
        countDiv.innerText = "æŸ¥è¯¢ä¸­...";
        paginationDiv.style.display = 'none';

        try {
            const contents = db.exec(sql);
            
            if (contents.length === 0) {
                countDiv.innerText = "å…±æŸ¥æ‰¾åˆ° 0 ä¸ªç»“æœ";
                resultsDiv.innerHTML = '<div class="col-12 text-center text-muted py-5"><h4>æœªæ‰¾åˆ°ç›¸å…³å¡ç‰Œ</h4></div>';
                return;
            }

            const columns = contents[0].columns;
            const values = contents[0].values;
            
            allCardsData = values.map(row => {
                let obj = {};
                columns.forEach((key, i) => obj[key] = row[i]);
                return obj;
            });

            if (isRandom) {
                countDiv.innerText = `éšæœºå±•ç¤º ${allCardsData.length} å¼ `;
            } else {
                countDiv.innerText = `å…±æŸ¥æ‰¾åˆ° ${allCardsData.length} ä¸ªç»“æœ`;
            }

            renderPage();

        } catch (err) {
            console.error(err);
            alert("SQL é”™è¯¯: " + err.message);
        }
    }

    function renderPage() {
        resultsDiv.innerHTML = '';
        
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, allCardsData.length);
        const pageCards = allCardsData.slice(startIndex, endIndex);

        if (pageCards.length === 0) return;

        pageCards.forEach(card => {
            let imgSrc;
            if (card.filename && card.filename.trim() !== "") {
                imgSrc = `ALL_IMAGES/${encodeURIComponent(card.filename)}`;
            } else {
                imgSrc = 'https://via.placeholder.com/300x400?text=æš‚æ— å›¾ç‰‡'; 
            }

            // åˆ†æ•° (å·¦ä¸Šè§’)
            let scoreHtml = "";
            if (card.score && card.score !== 'N/A' && card.score !== '') {
                scoreHtml = `<div class="score-badge">${card.score}</div>`;
            }

            // æ”»é˜² (ç§»è‡³æ–‡æœ¬åŒºåŸŸå³ä¸‹è§’)
            let ptHtml = "";
            if (card.power_toughness) {
                // ä½¿ç”¨ text-end è®©å®ƒé å³æ˜¾ç¤º
                ptHtml = `<div class="text-end"><span class="pt-badge">${card.power_toughness}</span></div>`;
            }

            // é£å‘³æ–‡å­—
            let flavorHtml = "";
            if (card.flavor_text) {
                flavorHtml = `<div class="mt-2 fst-italic small text-muted border-top pt-1">${card.flavor_text}</div>`;
            }

            const html = `
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <div class="card-img-wrapper">
                            <img src="${imgSrc}" class="card-img-top" 
                                 alt="${card.name}" 
                                 loading="lazy" 
                                 onerror="this.src='https://via.placeholder.com/300x400?text=åŠ è½½å¤±è´¥'">
                            ${scoreHtml}
                            <!-- æ”»é˜²å·²ä»è¿™é‡Œç§»èµ° -->
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <h5 class="card-title text-primary text-truncate mb-0" title="${card.name}">${card.name}</h5>
                            </div>
                            
                            <h6 class="card-subtitle mb-2 text-muted small text-truncate border-bottom pb-1" title="${card.type}">${card.type || 'ç±»åˆ«æœªçŸ¥'}</h6>
                            
                            <div class="oracle-text flex-grow-1 small" style="white-space: pre-wrap;">${card.oracle_text || 'æš‚æ— è§„åˆ™æ–‡æœ¬'}</div>
                            
                            ${flavorHtml}
                            ${ptHtml}

                            <div class="mt-auto pt-2 d-flex justify-content-between align-items-center small text-secondary border-top mt-2">
                                <span class="text-truncate" style="max-width: 100%;" title="${card.author}">ä½œè€…ï¼š${card.author}</span>
                            </div>
                        </div>
                        <div class="card-footer bg-light text-muted small text-end py-1">
                            ${card.week}
                        </div>
                    </div>
                </div>
            `;
            resultsDiv.insertAdjacentHTML('beforeend', html);
        });

        updatePaginationUI();
    }

    function updatePaginationUI() {
        const totalPages = Math.ceil(allCardsData.length / pageSize);
        if (totalPages > 1) {
            paginationDiv.style.display = 'flex';
            pageInfoSpan.innerText = `ç¬¬ ${currentPage} / ${totalPages} é¡µ`;
            btnPrev.disabled = (currentPage === 1);
            btnNext.disabled = (currentPage === totalPages);
        } else {
            paginationDiv.style.display = 'none';
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function changePage(delta) {
        const totalPages = Math.ceil(allCardsData.length / pageSize);
        const newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            renderPage();
        }
    }

    function searchData() {
        const combined = document.getElementById('searchCombined').value.trim();
        const name = document.getElementById('searchName').value.trim();
        const author = document.getElementById('searchAuthor').value.trim();
        const week = document.getElementById('searchWeek').value.trim();
        const type = document.getElementById('searchType').value.trim();
        const text = document.getElementById('searchOracle').value.trim();

        const safe = (str) => str.replace(/'/g, "''");

        let sql = `SELECT * FROM cards WHERE 1=1`;

        if (combined) {
            const s = safe(combined);
            sql += ` AND (
                REPLACE(name, char(10), '') LIKE '%${s}%' OR 
                REPLACE(oracle_text, char(10), '') LIKE '%${s}%' OR 
                REPLACE(type, char(10), '') LIKE '%${s}%' OR
                REPLACE(flavor_text, char(10), '') LIKE '%${s}%'
            )`;
        }

        if (name) sql += ` AND REPLACE(name, char(10), '') LIKE '%${safe(name)}%'`;
        if (author) sql += ` AND author LIKE '%${safe(author)}%'`;
        if (week) sql += ` AND week LIKE '%${safe(week)}%'`;
        if (type) sql += ` AND REPLACE(type, char(10), '') LIKE '%${safe(type)}%'`;
        if (text) sql += ` AND REPLACE(oracle_text, char(10), '') LIKE '%${safe(text)}%'`;

        sql += ` ORDER BY id DESC`;

        runQuery(sql);
    }

    function clearSearch() {
        document.querySelectorAll('.search-field').forEach(input => input.value = '');
        searchData(); 
    }

    document.querySelectorAll('.search-field').forEach(input => {
        input.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') searchData();
        });
    });

    initApp();
</script>

</body>
</html>