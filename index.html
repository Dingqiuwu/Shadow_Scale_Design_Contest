<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>万智牌设计大赛卡牌数据库 alpha</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    <style>
        body { background-color: #f8f9fa; padding-bottom: 80px; }
        
        .card-img-wrapper {
            position: relative;
            background-color: #e9ecef;
            padding: 5px;
            border-bottom: 1px solid #eee;
        }

        .card-img-top {
            width: 100%;
            height: 300px;
            object-fit: contain;
        }

        .card { 
            height: 100%; 
            transition: transform 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            border: none;
            overflow: hidden;
        }
        .card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .oracle-text {
            white-space: pre-wrap;
            font-size: 0.85rem;
            color: #444;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 4px;
            margin-top: 10px;
            border: 1px solid #eee;
        }
        
        .score-badge {
            position: absolute;
            bottom: 10px;
            left: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            color: #fff;
            background-color: rgba(0, 0, 0, 0.7);
            border-radius: 4px;
            border: 1px solid #ffd700;
            box-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            z-index: 10;
        }

        .pt-badge {
            display: inline-block;
            font-size: 1.2rem;
            font-weight: bold;
            color: #333;
            background-color: #fff;
            padding: 4px 12px;
            margin-top: 5px; 
        }

        .meta-tag { font-size: 0.8em; color: #6c757d; }
        #loading { display: none; text-align: center; margin: 40px; }
        
        .search-panel {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            margin-bottom: 25px;
        }
        
        .pagination-container {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        
        #searchCombined {
            border-color: #86b7fe;
            background-color: #f0f7ff;
        }
        #searchCombined:focus {
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.15);
        }
    </style>
</head>
<body>

<div class="container mt-4">
    <h1 class="text-center mb-4">万智牌设计大赛卡牌数据库alpha</h1>
    
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="search-panel">
                <div class="row g-3">
                    <!-- 联合搜索 -->
                    <div class="col-12">
                        <label for="searchCombined" class="form-label fw-bold text-primary">
                            联合搜索
                        </label>
                        <input type="text" class="form-control search-field form-control-lg" id="searchCombined" 
                               placeholder="同时查找 牌名 / 类别 / 规则文本 / 风味文字">
                    </div>

                    <div class="col-12"><hr class="text-muted"></div>

                    <!-- 精确筛选 -->
                    <div class="col-md-4">
                        <label for="searchName" class="form-label small text-muted">仅搜牌名 (Name)</label>
                        <input type="text" class="form-control search-field" id="searchName" placeholder="例如：荆轲">
                    </div>
                    <div class="col-md-4">
                        <label for="searchAuthor" class="form-label small text-muted">仅搜作者 (Author)</label>
                        <input type="text" class="form-control search-field" id="searchAuthor" placeholder="例如：HalfLife">
                    </div>
                    <div class="col-md-4">
                        <label for="searchWeek" class="form-label small text-muted">仅搜时间 (Week)</label>
                        <input type="text" class="form-control search-field" id="searchWeek" placeholder="例如：第三十六周">
                    </div>

                    <div class="col-md-4">
                        <label for="searchType" class="form-label small text-muted">仅搜类别 (Type)</label>
                        <input type="text" class="form-control search-field" id="searchType" placeholder="例如：传奇生物">
                    </div>
                    <div class="col-md-8">
                        <label for="searchOracle" class="form-label small text-muted">仅搜规则 (Oracle Text)</label>
                        <input type="text" class="form-control search-field" id="searchOracle" placeholder="例如：造成3点伤害">
                    </div>

                    <div class="col-12 text-end mt-3">
                        <button class="btn btn-outline-secondary me-2" onclick="clearSearch()">重置条件</button>
                        <button class="btn btn-primary px-5" onclick="searchData()">查询</button>
                    </div>
                </div>
            </div>

            <div id="resultCount" class="text-center text-muted mt-2" style="font-size: 0.9rem; min-height: 24px;"></div>
        </div>
    </div>

    <div id="loading">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-2 text-muted">正在读取数据库...</p>
    </div>

    <div id="results" class="row row-cols-1 row-cols-md-2 row-cols-lg-3 row-cols-xl-4 g-4"></div>

    <div id="pagination" class="pagination-container" style="display: none;">
        <button id="btnPrev" class="btn btn-outline-primary" onclick="changePage(-1)">« 上一页</button>
        <span id="pageInfo" class="fw-bold text-secondary">第 1 / 1 页</span>
        <button id="btnNext" class="btn btn-outline-primary" onclick="changePage(1)">下一页 »</button>
    </div>
</div>

<script>
    let db = null;
    let allCardsData = [];
    let currentPage = 1;
    const pageSize = 20;

    const loadingDiv = document.getElementById('loading');
    const resultsDiv = document.getElementById('results');
    const countDiv = document.getElementById('resultCount');
    const paginationDiv = document.getElementById('pagination');
    const pageInfoSpan = document.getElementById('pageInfo');
    const btnPrev = document.getElementById('btnPrev');
    const btnNext = document.getElementById('btnNext');

    async function initApp() {
        loadingDiv.style.display = 'block';
        try {
            if (typeof initSqlJs === 'undefined') throw new Error("sql.js 库未能加载");

            const SQL = await initSqlJs({
                locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
            });

            const dataPromise = fetch("cards.db?" + new Date().getTime()).then(res => {
                if (!res.ok) throw new Error(`无法下载数据库 (Status: ${res.status})`);
                return res.arrayBuffer();
            });

            const [buf] = await Promise.all([dataPromise]);
            db = new SQL.Database(new Uint8Array(buf));
            
            loadingDiv.style.display = 'none';
            console.log("数据库加载成功");
            
            searchData(); 
            
        } catch (err) {
            console.error(err);
            loadingDiv.innerHTML = `<div class="alert alert-danger">加载失败: ${err.message}<br><small>请确保使用 python -m http.server 启动</small></div>`;
        }
    }

    function runQuery(sql, isRandom = false) {
        if (!db) return;
        
        allCardsData = [];
        currentPage = 1;
        resultsDiv.innerHTML = '';
        countDiv.innerText = "查询中...";
        paginationDiv.style.display = 'none';

        try {
            const contents = db.exec(sql);
            
            if (contents.length === 0) {
                countDiv.innerText = "共查找到 0 个结果";
                resultsDiv.innerHTML = '<div class="col-12 text-center text-muted py-5"><h4>未找到相关卡牌</h4></div>';
                return;
            }

            const columns = contents[0].columns;
            const values = contents[0].values;
            
            allCardsData = values.map(row => {
                let obj = {};
                columns.forEach((key, i) => obj[key] = row[i]);
                return obj;
            });

            if (isRandom) {
                countDiv.innerText = `随机展示 ${allCardsData.length} 张`;
            } else {
                countDiv.innerText = `共查找到 ${allCardsData.length} 个结果`;
            }

            renderPage();

        } catch (err) {
            console.error(err);
            alert("SQL 错误: " + err.message);
        }
    }

    function renderPage() {
        resultsDiv.innerHTML = '';
        
        const startIndex = (currentPage - 1) * pageSize;
        const endIndex = Math.min(startIndex + pageSize, allCardsData.length);
        const pageCards = allCardsData.slice(startIndex, endIndex);

        if (pageCards.length === 0) return;

        pageCards.forEach(card => {
            let imgSrc;
            if (card.filename && card.filename.trim() !== "") {
                imgSrc = `ALL_IMAGES/${encodeURIComponent(card.filename)}`;
            } else {
                imgSrc = 'https://via.placeholder.com/300x400?text=暂无图片'; 
            }

            // 分数 
            let scoreHtml = "";
            if (card.score && card.score !== 'N/A' && card.score !== '') {
                scoreHtml = `<div class="score-badge">${card.score}</div>`;
            }

            // 攻防 
            let ptHtml = "";
            if (card.power_toughness) {
                ptHtml = `<div class="text-end"><span class="pt-badge">${card.power_toughness}</span></div>`;
            }

            // 风味文字
            let flavorHtml = "";
            if (card.flavor_text) {
                flavorHtml = `<div class="mt-2 fst-italic small text-muted border-top pt-1">${card.flavor_text}</div>`;
            }

            const html = `
                <div class="col">
                    <div class="card h-100 shadow-sm">
                        <div class="card-img-wrapper">
                            <img src="${imgSrc}" class="card-img-top" 
                                 alt="${card.name}" 
                                 loading="lazy" 
                                 onerror="this.src='https://via.placeholder.com/300x400?text=加载失败'">
                            ${scoreHtml}
                        </div>
                        <div class="card-body d-flex flex-column">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <h5 class="card-title text-primary text-truncate mb-0" title="${card.name}">${card.name}</h5>
                            </div>
                            
                            <h6 class="card-subtitle mb-2 text-muted small text-truncate border-bottom pb-1" title="${card.type}">${card.type || '类别未知'}</h6>
                            
                            <div class="oracle-text flex-grow-1 small" style="white-space: pre-wrap;">${card.oracle_text || '暂无规则文本'}</div>
                            
                            ${flavorHtml}
                            ${ptHtml}

                            <div class="mt-auto pt-2 d-flex justify-content-between align-items-center small text-secondary border-top mt-2">
                                <span class="text-truncate" style="max-width: 100%;" title="${card.author}">作者：${card.author}</span>
                            </div>
                        </div>
                        <div class="card-footer bg-light text-muted small text-end py-1">
                            ${card.week}
                        </div>
                    </div>
                </div>
            `;
            resultsDiv.insertAdjacentHTML('beforeend', html);
        });

        updatePaginationUI();
    }

    function updatePaginationUI() {
        const totalPages = Math.ceil(allCardsData.length / pageSize);
        if (totalPages > 1) {
            paginationDiv.style.display = 'flex';
            pageInfoSpan.innerText = `第 ${currentPage} / ${totalPages} 页`;
            btnPrev.disabled = (currentPage === 1);
            btnNext.disabled = (currentPage === totalPages);
        } else {
            paginationDiv.style.display = 'none';
        }
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function changePage(delta) {
        const totalPages = Math.ceil(allCardsData.length / pageSize);
        const newPage = currentPage + delta;
        if (newPage >= 1 && newPage <= totalPages) {
            currentPage = newPage;
            renderPage();
        }
    }

    function searchData() {
        const combined = document.getElementById('searchCombined').value.trim();
        const name = document.getElementById('searchName').value.trim();
        const author = document.getElementById('searchAuthor').value.trim();
        const week = document.getElementById('searchWeek').value.trim();
        const type = document.getElementById('searchType').value.trim();
        const text = document.getElementById('searchOracle').value.trim();

        const safe = (str) => str.replace(/'/g, "''");

        let sql = `SELECT * FROM cards WHERE 1=1`;

        if (combined) {
            const s = safe(combined);
            sql += ` AND (
                REPLACE(name, char(10), '') LIKE '%${s}%' OR 
                REPLACE(oracle_text, char(10), '') LIKE '%${s}%' OR 
                REPLACE(type, char(10), '') LIKE '%${s}%' OR
                REPLACE(flavor_text, char(10), '') LIKE '%${s}%'
            )`;
        }

        if (name) sql += ` AND REPLACE(name, char(10), '') LIKE '%${safe(name)}%'`;
        if (author) sql += ` AND author LIKE '%${safe(author)}%'`;
        if (week) sql += ` AND week LIKE '%${safe(week)}%'`;
        if (type) sql += ` AND REPLACE(type, char(10), '') LIKE '%${safe(type)}%'`;
        if (text) sql += ` AND REPLACE(oracle_text, char(10), '') LIKE '%${safe(text)}%'`;

        sql += ` ORDER BY id DESC`;

        runQuery(sql);
    }

    function clearSearch() {
        document.querySelectorAll('.search-field').forEach(input => input.value = '');
        searchData(); 
    }

    document.querySelectorAll('.search-field').forEach(input => {
        input.addEventListener('keypress', function (e) {
            if (e.key === 'Enter') searchData();
        });
    });

    initApp();
</script>

</body>
</html>